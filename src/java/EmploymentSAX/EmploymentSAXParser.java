package EmploymentSAX;


import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;
import javax.xml.bind.JAXBContext;
import javax.xml.bind.JAXBException;
import javax.xml.bind.Marshaller;
import javax.xml.parsers.ParserConfigurationException;
import javax.xml.parsers.SAXParser;
import javax.xml.parsers.SAXParserFactory;
import org.xml.sax.Attributes;
import org.xml.sax.SAXException;
import org.xml.sax.helpers.DefaultHandler;

/**
 * ProfileBySAX uses a ContentHandler to write the profile to an XML File. The
 * ContantHandler is passed to objects of inner classes that extend from
 * DefaulHandler. These classes write elements and attributes to the
 * ContentHandler as events are generated by the SAX parser.
 *
 */
public class EmploymentSAXParser {


    String ssn = "8606261111";
    Employments employmentsElement = null;

    public EmploymentSAXParser(String ssn) {
        this.ssn = ssn;
        parse();
        createFile("src/java/Xml/employmentsResult.xml");        
    }
    
        
    private void print() {
        System.out.println(employmentsElement);
    }

    public void parse() {

        try {
            // Create Parser
            SAXParserFactory saxpf = SAXParserFactory.newInstance();
            SAXParser saxp = saxpf.newSAXParser();

            saxp.parse("src/java/Xml/employmentrecords.xml", new MyParser(ssn));

        } catch (ParserConfigurationException | SAXException | IOException ex) {
            ex.printStackTrace();
        }
    }

    class MyParser extends DefaultHandler {

        List<Employment> employments = new ArrayList<>();
        Employment employment = null;

        private String ssn = null;
        private boolean foundSsn = false;
        private boolean record = false;
        private boolean getOrg = false;
        private boolean getStart = false;
        private boolean getEnd = false;

        //Constructor
        public MyParser(String ssn) {
            this.ssn = ssn;
        }

        @Override
        public void startElement(String uri, String localName, String qName, Attributes attributes) throws SAXException {

            if (foundSsn == true) {
                if (record == true) {
                    if (qName.equals("employment")) {
                        employment = new Employment();
                    } else if (qName.equals("orgNumber")) {
                        getOrg = true;
                    } else if (qName.equals("startDate")) {
                        getStart = true;
                    } else if (qName.equals("endDate")) {
                        getEnd = true;
                    }
                } else if (qName.equals("employments")) {
                    record = true;
                }
            }
        }

        @Override
        public void characters(char[] ch, int start, int length) throws SAXException {
            String string = new String(ch, start, length).trim();
            if (string.equals(ssn)) {
                foundSsn = true;
            }
            if (foundSsn == true && record == true) {
                if (getOrg == true) {
                    employment.setOrgNumber(string);
                } else if (getStart == true) {
                    employment.setStartDate(string);
                } else if (getEnd == true) {
                    employment.setEndDate(string);
                }
            }

        }

        @Override
        public void endElement(String uri, String localName, String qName) throws SAXException {
            
            if (qName.equals("employments") && foundSsn == true && record == true) {
                record = false;
                foundSsn = false;
                
                employmentsElement = new Employments();
                employmentsElement.setEmployments(employments);
            }
            if (foundSsn == true && record == true) {
                if (qName.equals("employment")) {
                    employments.add(employment);
                } else if (qName.equals("orgNumber")) {
                    getOrg = false;
                } else if (qName.equals("startDate")) {
                    getStart = false;
                } else if (qName.equals("endDate")) {
                    getEnd = false;
                }
            }
        }

        @Override
        public void startDocument() throws SAXException {
        }

        @Override
        public void endDocument() throws SAXException {
        }
    }

    public Employments getEmployments() {
        return employmentsElement;
    }

    public void createFile(String fileName) {
        try {

            File file = new File(fileName);
            JAXBContext jaxbContextEmployment = JAXBContext.newInstance(Employments.class);
            Marshaller jaxbMarshaller = jaxbContextEmployment.createMarshaller();

            // output pretty printed
            jaxbMarshaller.setProperty(Marshaller.JAXB_FORMATTED_OUTPUT, true);

            jaxbMarshaller.marshal(employmentsElement, file);
            jaxbMarshaller.marshal(employmentsElement, System.out);


        } catch (JAXBException e) {
            e.printStackTrace();
        }

    }

}
